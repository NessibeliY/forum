<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/svg+xml" href="../static/images/logo.png" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <title>FORUM</title>
</head>
<body> 
    {{ template "header" .}}
    <main class="main_container">
        <div class="offset">
            <!--LIST OF TAGS-->
            <div class="tags card bg-white">
                <h3 class="font-semibold">Tags</h3>
                {{range .categories}}
                    <div class="flex flex-col">
                        <a href="/showposts?category={{.Name}}" class="categories hover:text-blue-400 duration-300 transition">#{{ .Name}}</a>
                    </div>
                {{end}}
            </div>

            <!-- IF USER AUTH SHOW THIS BLOCK -->
            <div class="middleContainer">
                <div class="flex w-full flex-col break-words">
                    <div class="flex w-full items-center justify-between">
                        <h2 class="text-4xl">{{.post.Title}}</h2>
                         <!-- CHECK IF USER IS OWNER -->
                        {{if $.authenticated_user}}
                        {{if eq $.authenticated_user.ID  .post.AuthorID  }}
                        <div class="text-xl dropdown">
                            <i class="fa-solid fa-bars" data-target="dropdown-{{.ID}}"></i>
                            <div class="select_menu " id="dropdown-{{.ID}}">
                                <ul class="options card">
                                    <li class="option del_btn_modal" data-modal="delete_modal_{{.ID}}">
                                        Delete
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!-- DELETE POST MODAL SUBMIT -->
                        <div class="modal" id="delete_modal_{{.ID}}">
                            <div class="modal-content delete_form_modal">
                                <div class="flex items-center justify-between w-full">
                                    <span class="text-bold text-2xl">DELETE POST</span>
                                    <span class="close" data-close="delete_modal_{{.ID}}">&times;</span>
                                </div>
                                <form action="/post/delete?id={{.post.ID}}" method="POST" class="flex flex-col items-center justify-center w-full mt-3">
                                    <!-- <input type="hidden" name="PostID" value="{{.ID}}"> -->
                                    <p class="text-xl">Are you sure??</p>
                                    <div class="flex items-center justify-center mt-2">
                                        <button class="bg-red-600 py-2 px-2 mx-1 rounded-lg text-white hover:bg-red-700 transition duration-300" type="submit">yes</button>
                                        <div class="bg-green-600 py-2 px-2 mx-1 rounded-lg text-white hover:bg-green-700 transition duration-300 cursor-pointer" data-close="delete_modal_{{.ID}}">no</div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    {{end}}
                    {{end}}
                    </div>
                    <span class="postDescription">{{.post.Content}}</span>                    
                </div>
                <div class="flex w-full items-center">
                    <form action="/post/reaction/create" method="POST" class="flex my-2 mb-2">   
                        <input type="hidden" name="post_id" value="{{.post.ID}}">
                        <input type="hidden" name="reaction" value="like">
                        {{if .post.IsLikedByUser}}
                        <button class="btn_like btn_like_active text-2xl" type="submit">
                            <i class="fa-regular fa-thumbs-up mx-1"></i> Liked({{ .post.LikesCount }})
                        </button>
                        {{else}}
                        <button class="btn_like text-white text-2xl" type="submit">
                            <i class="fa-regular fa-thumbs-up mx-1"></i>Liked({{ .post.LikesCount }})
                        </button>
                        {{end}}
                    </form>
        
    
                    <form action="/post/reaction/create" method="POST">
                        <input type="hidden" name="post_id" value="{{.post.ID}}">
                        <input type="hidden" name="reaction" value="dislike">
                        {{if .post.IsDislikedByUser}}
                        <button class="btn_like btn_like_active text-2x" type="submit">
                            <i class="fa-regular fa-thumbs-down mx-1"></i>Disliked({{.post.DislikesCount}})
                        </button>
                        {{else}}
                        <button class="btn_like text-white text-2xl" type="submit">
                            <i class="fa-regular fa-thumbs-down mx-1"></i>Disliked({{.post.DislikesCount}})
                        </button>
                        {{end}}
                    </form>
                </div>
                <!-- INPUT COMMENT -->
                <div class="flex flex-col mb-4">
                    {{if .authenticated_user}}
                        {{if .authenticated_user.ID}}
                        <form class="flex_full_col" style="align-items: center;" action="/comment/create" method="POST">
                            <input type="hidden" name="post_id" id="PostID" value="{{$.post.ID}}">
                            <div class="flex_full_col ">
                                <textarea
                                id="comment-text-area"
                                name="content"
                                class="border border-gray-500 rounded-md w-full focus:outline-none focus:border-blue-600 py-3 px-3"
                                rows="2"
                                cols="20"></textarea>
                                <button type="submit" style="margin-top: 2%;" class="btn_create btn_auth bg-indigo-500 hover:bg-indigo-600 duration-300 transition">
                                Create comment
                                </button>
                                <!--ADD LIKKES AND DISLIKES HERE-->
                            </div>
                        </form>
                        {{end}}
                    {{end}}
                    <!-- COMMENT LIST -->
                    {{range .comments}}
                        <div class="comments">
                            <div class="commentHeader">
                                <div class="flex justify-between">
                                    <div class="flex items-center">
                                        <div class="post_icon user_icon">
                                            <i class="fa-solid fa-user"></i>
                                        </div>
                                        <span class="commentAuthor">{{.ID}}</span>
                                        <div class="flex w-full items-center flex-col ml-2 text">
                                                <span class="created-at">{{ .CreatedAt.Format "02-01-2006 15:04"}}</span>
                                        </div>
                                    </div>
                      
                                      
                                    {{if $.authenticated_user}}
                                    {{if eq  $.authenticated_user.ID .AuthorID}}        
                                    <div class="text-xl dropdown">
                                        <i class="fa-solid fa-bars" data-target="dropdown-{{.ID}}"></i>
                                        <div class="select_menu" id="dropdown-{{.ID}}">
                                            <ul class="options card">
                                                <li class="option del_btn_modal" data-modal="delete_comm_{{.ID}}">
                                                    Delete                                         
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="modal" id="delete_comm_{{.ID}}">
                                        <div class="modal-content delete_form_modal">
                                            <div class="flex items-center justify-between w-full">
                                                <span class="text-bold text-2xl">DELETE COMMENT</span>
                                                <span class="close" data-close="delete_comm_{{.ID}}">&times;</span>
                                            </div>
                                            <form action="/user/comment/delete" method="POST" class="flex flex-col items-center justify-center w-full mt-3">
                                                <input type="hidden" name="CommentID" value="{{.ID}}">
                                                <input type="hidden" name="PostID" id="post-id-like" value="{{$.post.ID}}">
                                                <p class="text-xl">Are you sure??</p>
                                                <div class="flex items-center justify-center mt-2">
                                                    <button class="bg-red-600 py-2 px-2 mx-1 rounded-lg text-white hover:bg-red-700 transition duration-300" type="submit">yes</button>
                                                    <div class="bg-green-600 py-2 px-2 mx-1 rounded-lg text-white hover:bg-green-700 transition duration-300 cursor-pointer" data-close="delete_comm_{{.ID}}">no</div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                    {{end}} 
                                    {{end}}
                                </div>   
                            </div>
                            <span class="commentText">{{ .Content }}</span>
                            <div class="flex py-2 justify-between">
                                <div class="flex items-start w-full">
                                    <form class="flex" action="/comment/reaction/create" method="POST">
                                        <input type="hidden" name="comment_id" value="{{.ID}}">
                                        <input type="hidden" name="PostID" id="post-id-like" value="{{$.post.ID}}">
                                        <input type="hidden" name="reaction" value="like">
                                        {{if .IsLikedByUser}}
                                        <button class="btn_like_com btn_like_active">
                                            <i class="fa-regular fa-thumbs-up mx-1"></i> Liked ({{ .LikesCount }})
                                        </button>
                                        {{ else }}
                                        <button class="btn_like_com">
                                            <i class="fa-regular fa-thumbs-up mx-1"></i> Liked ({{ .LikesCount }})
                                        </button>
                                        {{ end }}
                                    </form>
                                    <form action="/comment/reaction/create" method="POST">
                                        <input type="hidden" name="comment_id" value="{{.ID}}">
                                        <input type="hidden" name="PostID" id="post-id-like" value="{{$.post.ID}}">
                                        <input type="hidden" name="reaction" value="dislike">
                                        {{if .IsDislikedByUser}}
                                        <button class="btn_like_com btn_like_active">
                                            <i class="fa-regular fa-thumbs-down mx-1"></i>Disliked ({{.DislikesCount}})
                                        </button>     
                                        {{else}}
                                        <button class="btn_like_com">
                                            <i class="fa-regular fa-thumbs-down mx-1"></i>Disliked ({{ .DislikesCount}})
                                        </button>
                                        {{end}}    
                                    </form>
                                </div> 
                            </div> 
                        </div>
                    {{end}}
                </div>
            </div>
            
            <!-- USER INFO -->
            {{if .authenticated_user}}
                {{if .authenticated_user.ID}}
                    <div class="rSide">
                        <div class="welcome card">
                            <div>
                                <h2 class="welcome_text" style="font-weight: 600; font-size: xx-large;">Hi, {{.authenticated_user.Username}}</h2>
                                <span style="font-size: larger;">Glad to see you!</span>                        
                            </div>
                            <a href="/post/create" class="createButton" id="openModalBtn">
                                <i class="fa-solid fa-plus mr-1 text-xl"></i> Create post
                            </a>
                        </div>
                        <div class="userInfo card">
                            {{ template "user_info" .}}
                        </div>
                    </div>
                {{end}}
            {{end}}
        </div>
    </main>
    
</body>
<script src="/static/js/script.js"></script>
<script>
    // Функция для получения значения параметра из URL
    function getQueryParam(param) {
        let params = new URLSearchParams(window.location.search);
        return params.get(param);
    }

    // Получаем post-id из URL
    let PostID = getQueryParam('post-id');
    if (PostID) {
        document.getElementById('PostID').value = PostID;
        document.getElementById('post-id-like').value = PostID
        document.getElementById('post-id-dislike').value = PostID
    }

    window.onload = function() {
        const commentTextArea = document.getElementById('comment-text-area');
        if (commentTextArea) {
            commentTextArea.focus();
            commentTextArea.setSelectionRange(0, 0); // Установка курсора в начало
        }
    }
    

    // Если post-id отсутствует, вы можете обрабатывать это соответствующим образом

    // Обработка нажатия на кнопку "Delete
    var del_btn_comm = document.querySelectorAll(".del_btn_comm")
    // var close_btn_modals = document.querySelectorAll("[data-close]")

    // Закрытие модального окна при нажатии на крестик или кнопку "no"
    del_btn_comm.forEach((btn) => {
        btn.addEventListener("click", (event) => {
            const modalId = btn.getAttribute('data-modal');
            const modal = document.getElementById(modalId);
            if (modal) {
              modal.style.display = "flex";
            } else {
              console.error(`No modal found for button with modal ID: ${modalId}`);
            }
        });
    })


    //Закрытие модального окна за при клике за пределами модального окна
    window.onclick = function(event) {
     if (event.target.classList.contains('modal')) {
        event.target.style.display = "none";
    }
};
</script>
</html>